<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ketchuplus+ ‚Äì Interakt√≠v tanul√≥ m√≥d</title>
  <style>
    /* --- Ketchupos arculat --- */
    :root{
      --ketchup:#b52127; /* f≈ë piros */
      --ketchup-700:#981b1f;
      --ketchup-900:#5b0f12;
      --cream:#fff7ef;
      --dark:#2d2d2d;
      --muted:#6b6b6b;
      --green:#2e7d32;
      --gold:#b8860b;
      --shadow:0 12px 30px rgba(0,0,0,.18);
      --radius:18px;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 85% 10%, rgba(181,33,39,.15), transparent 60%),
                  radial-gradient(900px 700px at 10% 90%, rgba(181,33,39,.12), transparent 60%),
                  var(--cream);
      color:var(--dark);
    }
    header{
      position:sticky; top:0; z-index:30; backdrop-filter:saturate(120%) blur(8px);
      background:linear-gradient(180deg, rgba(255,247,239,.9), rgba(255,247,239,.65));
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .nav{max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; gap:12px; align-items:center;}
    .logo{display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.3px; color:var(--ketchup);}
    .logo-badge{width:34px;height:34px;border-radius:9px;background:conic-gradient(from 220deg,var(--ketchup),var(--ketchup-700)); display:grid;place-items:center; color:#fff; box-shadow: var(--shadow)}
    .grow{flex:1}
    .pill{border:1px solid rgba(0,0,0,.08); padding:8px 12px; border-radius:999px; background:#fff; box-shadow:0 8px 20px rgba(181,33,39,.08);}

    /* Hero */
    .hero{max-width:1200px; margin:22px auto; padding:18px; display:grid; grid-template-columns: 1.1fr .9fr; gap:22px; align-items:center}
    .card{background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card.pad{padding:22px}
    .title{font-size: clamp(24px, 3.2vw, 40px); line-height:1.12; margin:6px 0 12px}
    .subtitle{color:var(--muted); font-size:clamp(14px,1.6vw,16px);}

    .cta-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:16px}
    .btn{appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer; transition: transform .18s ease, box-shadow .18s ease, background .18s ease;}
    .btn.primary{background:linear-gradient(180deg, var(--ketchup), var(--ketchup-700)); color:#fff; box-shadow: 0 10px 30px rgba(181,33,39,.35)}
    .btn.primary:hover{transform: translateY(-1px)}
    .btn.ghost{background:#fff; border:1px solid rgba(0,0,0,.08)}

    /* T√°blafel√ºlet */
    .table-wrap{position:relative; aspect-ratio: 4/3; border-radius:var(--radius); overflow:hidden;}
    .table{position:absolute; inset:0; background:
      radial-gradient(60% 100% at 50% 120%, rgba(0,0,0,.3), transparent 40%),
      radial-gradient(70% 80% at 0% 0%, rgba(255,255,255,.5), transparent 50%),
      linear-gradient(160deg, #fbe7dd, #fff6f0 40%, #fceadd 70%);
      border:1px solid rgba(0,0,0,.05);
    }
    .felt{position:absolute; inset:18px; border-radius:22px; background:
      radial-gradient(800px 400px at 50% 50%, rgba(181,33,39,.12), transparent 40%),
      linear-gradient(180deg, #fff, #fff8f4);
      box-shadow: inset 0 20px 60px rgba(0,0,0,.05);
    }

    /* J√°t√©kos helyek */
    .seat{position:absolute; display:grid; place-items:center; gap:8px; text-align:center}
    .seat .name{font-weight:800; letter-spacing:.3px}
    .seat .stacks{display:flex; gap:10px}
    .stack{width:72px; height:98px; border-radius:10px; background:#fff; border:1px solid rgba(0,0,0,.08); box-shadow:var(--shadow); position:relative}
    .stack::after{content:attr(data-label); position:absolute; inset:auto 0 -22px 0; text-align:center; font-size:12px; color:var(--muted)}

    /* K√∂z√©ps≈ë kupac + anim */
    .center{position:absolute; inset:auto 50% 50% auto; transform:translate(calc(-50% + 2px), calc(50% - 2px)); display:grid; place-items:center;}
    .pile{width:92px; height:124px; border-radius:12px; background:#fff; border:1px solid rgba(0,0,0,.08); box-shadow:var(--shadow); position:relative}
    .pile.ripple{animation:ripple .8s ease}
    @keyframes ripple{0%{box-shadow:0 0 0 0 rgba(181,33,39,.35)} 100%{box-shadow:0 0 0 22px rgba(181,33,39,0)}}

    /* K√°rtya megjelen√≠t√©s */
    .cardvis{position:absolute; inset:6px; border-radius:10px; display:grid; grid-template-rows:auto 1fr auto; padding:8px; font-weight:800}
    .cardvis.hungarian{background:linear-gradient(180deg,#fff,#fff2e1);}
    .rank{font-size:20px}
    .suit{font-size:22px}
    .big{display:grid; place-items:center; font-size:42px; opacity:.2}
    .red{color:var(--ketchup)}
    .black{color:#1a1a1a}
    .joker{background:linear-gradient(135deg,#fff, #f6f6f6);}
    .badge{position:absolute; top:6px; right:6px; background:var(--ketchup); color:#fff; font-size:11px; padding:3px 6px; border-radius:999px}

    /* HUD / szab√°ly-detekci√≥ */
    .hud{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px}
    .chip{border:1px solid rgba(0,0,0,.08); background:#fff; padding:8px 10px; border-radius:999px; font-weight:700; color:var(--muted)}
    .chip.ok{background:linear-gradient(180deg,#fdfafa, #ffe6e7); color:var(--ketchup); border-color:rgba(181,33,39,.3); box-shadow:0 8px 20px rgba(181,33,39,.15)}
    .chip.block{background:#f6f6f6; color:#9a9a9a}

    /* Tanul√≥-panel */
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap:18px}
    .ol{padding-left:18px; line-height:1.55; color:#3a3a3a}
    .callout{background:linear-gradient(180deg,#fff,#fff7f7); border:1px dashed rgba(181,33,39,.35); padding:12px 14px; border-radius:12px}

    /* Als√≥ vez√©rl≈ëk */
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#fff; border:1px solid rgba(0,0,0,.12); padding:4px 8px; border-radius:8px}

    /* Finom anim√°ci√≥k */
    .fade-up{opacity:0; transform:translateY(6px); animation:fadeup .6s ease forwards}
    .fade-up.d2{animation-delay:.1s}
    .fade-up.d3{animation-delay:.2s}
    .fade-up.d4{animation-delay:.3s}
    @keyframes fadeup{to{opacity:1; transform:none}}

    /* Respons√≠v */
    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .seat .stacks{flex-direction:column; align-items:center}
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo"><div class="logo-badge">üçÖ</div> Ketchuplus+ oktat√≥</div>
      <div class="grow"></div>
      <div class="pill">Nyomd meg a <span class="kbd">Space</span> gombot ‚ÄûChup!‚Äù-hoz</div>
    </div>
  </header>

  <section class="hero">
    <div class="card pad fade-up">
      <h1 class="title">Tanuld meg 5 perc alatt a <span style="color:var(--ketchup)">Ketchuplus+</span> j√°t√©kot!</h1>
      <p class="subtitle">Interakt√≠v gyakorl√≥ m√≥d: l√©p√©sr≈ël l√©p√©sre mutatjuk a szab√°lyokat, val√≥s idej≈± visszajelz√©ssel √©s finom anim√°ci√≥val. Minden a j√°t√©kszab√°ly szerint.</p>

      <div class="hud" id="ruleHud"></div>

      <div class="cta-row">
        <button class="btn primary" id="btnStart">‚û°Ô∏è Tanul√≥ m√≥d ind√≠t√°sa</button>
        <button class="btn ghost" id="btnPractice">üÉè Szabad gyakorl√°s</button>
        <label class="pill" style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="toggleJokers" /> Jokerek haszn√°lata (opcion√°lis)
        </label>
      </div>
    </div>

    <div class="card table-wrap fade-up d2">
      <div class="table">
        <div class="felt">
          <!-- 4 j√°t√©kos √ºl√©sek -->
          <div class="seat" style="top:10px; left:50%; transform:translate(-50%,0)" id="seat-0">
            <div class="name">√âszak (BOT)</div>
            <div class="stacks">
              <div class="stack" data-label="Pakli" id="deck-0"></div>
              <div class="stack" data-label="Nyerem√©ny" id="won-0"></div>
            </div>
          </div>
          <div class="seat" style="left:10px; top:50%; transform:translate(0,-50%)" id="seat-1">
            <div class="name">Nyugat (BOT)</div>
            <div class="stacks">
              <div class="stack" data-label="Pakli" id="deck-1"></div>
              <div class="stack" data-label="Nyerem√©ny" id="won-1"></div>
            </div>
          </div>
          <div class="seat" style="bottom:10px; left:50%; transform:translate(-50%,0)" id="seat-2">
            <div class="name">Te (J√°t√©kos)</div>
            <div class="stacks">
              <div class="stack" data-label="Pakli" id="deck-2"></div>
              <div class="stack" data-label="Nyerem√©ny" id="won-2"></div>
            </div>
          </div>
          <div class="seat" style="right:10px; top:50%; transform:translate(0,-50%)" id="seat-3">
            <div class="name">Kelet (BOT)</div>
            <div class="stacks">
              <div class="stack" data-label="Pakli" id="deck-3"></div>
              <div class="stack" data-label="Nyerem√©ny" id="won-3"></div>
            </div>
          </div>

          <!-- K√∂z√©ps≈ë dob√≥pakli -->
          <div class="center">
            <div class="pile" id="centerPile">
              <div class="cardvis" id="topCard" style="display:none"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="grid" style="max-width:1200px;margin:8px auto 24px; padding:0 18px">
    <div class="card pad fade-up d3">
      <h3 style="margin:4px 0 10px">Gyorstalpal√≥ (szab√°lyok √∂sszefoglalva)</h3>
      <ol class="ol">
        <li><strong>K√°rtyak√©szlet:</strong> 5√ó francia + 1√ó magyar pakli, √∂sszekeverve, egyenl≈ëen osztva. A paklik leford√≠tva; fel√ºlr≈ël h√∫zunk √©s a k√∂z√©pre dobjuk.</li>
        <li><strong>K√∂rkezd√©s:</strong> aki megnyerte az el≈ëz≈ë dob√≥paklit, az kezd. Ir√°ny szerint halad.</li>
        <li><strong>Chup (r√°csap√°s) ‚Äì mikor <em>szabad</em>?</strong> K√©peslap (K/Q/J/A), 4√ó azonos sz√≠n egym√°s ut√°n (piros/fekete), 3√ó azonos forma egym√°s ut√°n (‚ô†/‚ô•/‚ô¶/‚ô£), 2√ó azonos sz√°m egym√°s ut√°n, vagy speci√°lis <strong>3-as</strong>.</li>
        <li><strong>NEM szabad</strong> sz√°mozott lapra √∂nmag√°ban, <strong>7-esre</strong>, <strong>Jokerre</strong>, illetve <strong>magyar k√°rty√°ra</strong> ‚Äì ezek gy≈±jt√©sre mennek.</li>
        <li><strong>B√ºntet√©s:</strong> rossz chup = a saj√°t nyerem√©nypaklid tetej√©r≈ël <strong>+2</strong> lap megy felford√≠tva a k√∂z√©pre. B√ºntet≈ë lapokra nem szabad r√°chupolni.</li>
        <li><strong>Hetes:</strong> ir√°nyv√°lt√°s + <em>l√°thatatlan</em> (nem sz√°m√≠t bele a kombin√°ci√≥kba). Elt√©veszt√©s = b√ºntet√©s.</li>
        <li><strong>Joker:</strong> nem szabad r√° chuppolni (<em>+5</em> b√ºntet√©s). Joker ut√°n a <em>k√∂vetkez≈ë</em> chup-alkalmat <strong>ki kell hagyni</strong>; ha k√©t Joker egym√°s ut√°n j√∂n, a m√°sodikra m√°r szabad.</li>
        <li><strong>3-as:</strong> ha 3-asra chuppolsz, <em>nem</em> nyered a kupacot. V√°lassz egy j√°t√©kost, √©s vedd el a nyerem√©nypaklija tetej√©r≈ël a <strong>2 db magyar</strong> k√°rty√°j√°t (amennyi van).</li>
        <li><strong>Pontoz√°s a v√©g√©n:</strong> magyar lapok √©rt√©kesebbek; francia: sz√°m = 1p, figur√°k = 2p, √°sz = 3p. ‚ÄûSzakadt bubi‚Äù = ‚àí30p.</li>
      </ol>
      <div class="callout">Tipp: a <span class="kbd">Space</span> gomb a leggyorsabb ‚ÄûChup!‚Äù.
        A HUD jelzi, ha √©ppen <strong>szabad</strong>, <strong>tilos</strong>, vagy <strong>kihagyand√≥</strong> a r√°csap√°s.
      </div>
    </div>

    <div class="card pad fade-up d4">
      <h3 style="margin:4px 0 10px">Vez√©rl≈ëk</h3>
      <div class="controls" style="margin-bottom:10px">
        <button class="btn primary" id="btnDeal">üÇ† √öj oszt√°s</button>
        <button class="btn ghost" id="btnFlip">ü°á K√∂vetkez≈ë lap</button>
        <button class="btn ghost" id="btnChup">‚úã Chup!</button>
        <span class="pill" id="turnInfo">‚Äì</span>
      </div>
      <div class="callout" id="log" style="min-height:84px"></div>
    </div>
  </section>

  <script>
  /********************
   * Ketchuplus+ engine
   * ‚Äì a szab√°lyok a felt√∂lt√∂tt j√°t√©kszab√°ly szerint
   ********************/
  const SUITS = ["‚ô†","‚ô•","‚ô¶","‚ô£"]; // francia
  const H_SUITS = ["Z","T","M","A"];  // magyar jel√∂l√©s (Z√∂ld, T√∂k, Makk, Piros ‚Äì vizu√°lis helytart√≥)
  const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"]; // francia
  const H_RANKS = ["VII","VIII","IX","X","Als√≥","Fels≈ë","K","A"]; // magyar ‚Äì csak kijelz√©shez

  const state = {
    players: [], // {deck:[], won:[], name}
    center: [],
    turn: 0,
    dir: 1, // 1 √≥ramutat√≥, -1 ellenkez≈ë
    lastWinner: 0,
    allowJokers: false,
    skipNextSlap: false,
    penaltyPhase: false,
    mode: "learn", // learn | practice
  };

  const hud = document.getElementById('ruleHud');
  const log = document.getElementById('log');
  const topCardEl = document.getElementById('topCard');
  const pileEl = document.getElementById('centerPile');
  const turnInfo = document.getElementById('turnInfo');

  // Util
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a }
  function takeTop(arr, n=1){return arr.splice(-n, n)} // tetej√©r≈ël n elem (stack v√©g√©t tekintj√ºk tetej√©nek)
  function pushTop(arr, items){arr.push(...items)}
  function clone(o){return JSON.parse(JSON.stringify(o))}

  function mkFrenchDeck(includeJokers){
    const d=[]
    for(let k=0;k<5;k++){ // 5 pakli
      for(const s of SUITS){
        for(const r of RANKS){ d.push({type:'FR', r, s, color:(s==='‚ô•'||s==='‚ô¶')?'R':'B'}) }
      }
      if(includeJokers){ d.push({type:'FR', r:'JOKER', s:'‚òÖ', joker:true}); d.push({type:'FR', r:'JOKER', s:'‚òÜ', joker:true}); }
    }
    return d
  }
  function mkHungarianDeck(){
    // egyszer≈± vizu√°lis magyar pakli (32 lap) helyettes√≠t≈ë jel√∂l√©sekkel
    const d=[]
    const suits = ['T√∂k','Makk','Z√∂ld','Piros'];
    const ranks = ['VII','VIII','IX','X','Als√≥','Fels≈ë','K','A'];
    for(const s of suits){ for(const r of ranks){ d.push({type:'HU', hr:r, hs:s}) } }
    return d
  }

  function buildFullDeck(){
    const includeJokers = state.allowJokers;
    const french = mkFrenchDeck(includeJokers);
    const hungarian = mkHungarianDeck();
    const full = shuffle([...french, ...hungarian]);
    return full
  }

  function deal(nbPlayers=4){
    state.players = Array.from({length: nbPlayers}, (_,i)=>({deck:[], won:[], name: i===2? 'Te':'BOT'}));
    state.center = [];
    state.dir = 1; state.turn = 0; state.lastWinner = 0; state.skipNextSlap = false; state.penaltyPhase=false;

    const full = buildFullDeck();
    // egyenl≈ë eloszt√°s, leford√≠tva
    for(let i=0;i<full.length;i++){
      state.players[i%nbPlayers].deck.unshift(full[i]); // unshift -> alulra tessz√ºk, hogy a "teteje" a t√∂mb v√©ge legyen
    }
    renderAll();
    info(`üÇ† Oszt√°s k√©sz. Lapok kiosztva ${nbPlayers} j√°t√©kos k√∂z√∂tt. ${state.allowJokers? 'Jokerek bekapcsolva.':'Jokerek kikapcsolva (260 + 32).'} `);
  }

  function currentPlayer(){ return state.players[state.turn] }
  function nextTurn(){ state.turn = (state.turn + state.dir + state.players.length) % state.players.length; updateTurnInfo() }

  function updateTurnInfo(){ turnInfo.textContent = `K√∂r: ${state.turn+1}. j√°t√©kos (${state.turn===2?'Te':'BOT'}) ${state.dir===1? '‚Üí' : '‚Üê'}` }

  function drawToCenter(){
    const p = currentPlayer();
    if(p.deck.length===0){ info(`‚ö†Ô∏è ${state.turn===2?'N√°lad':'Botn√°l'} elfogyott a pakli.`); nextTurn(); return }
    const card = takeTop(p.deck,1)[0];
    pushTop(state.center,[{...card, from: state.turn}]);

    // Hetes: ir√°nyv√°lt√°s + l√°thatatlan a mint√°kban
    if(card.type==='FR' && card.r==='7'){
      state.dir *= -1;
      info(`üîÅ Hetes! Ir√°nyv√°lt√°s. A 7-es l√°thatatlan a kombin√°ci√≥khoz.`)
    }

    renderAll(true);

    // Botok automatikus chuppol√°sa tanul√≥ m√≥dban csak akkor, ha teljesen egy√©rtelm≈± √©s nincs kihagy√°s/joker tilt√°s
    if(state.mode==='learn'){
      const can = canChup();
      if(can.allowed && !can.mustSkip && !state.penaltyPhase){ // ‚Äûtiszt√°n szabad‚Äù
        // Adj egy kis k√©sleltet√©st, hogy a j√°t√©kos is l√°ssa
        setTimeout(()=>{ if(state.turn!==2) handleChup(state.turn, {auto:true}) }, 400)
      }
    }

    nextTurn();
  }

  // Szab√°lydetektorok
  function visibleCenterForCombos(){
    // 7-eseket ‚Äûl√°thatatlanra‚Äù vessz√ºk a mint√°khoz
    return state.center.filter(c=>!(c.type==='FR' && c.r==='7'))
  }

  function last(n){ const arr=visibleCenterForCombos(); return arr.slice(-n) }

  function isFaceCard(c){ return c.type==='FR' && (c.r==='K'||c.r==='Q'||c.r==='J'||c.r==='A') }
  function isNumberCard(c){ return c.type==='FR' && !isFaceCard(c) && !c.joker }
  function isHungarian(c){ return c.type==='HU' }

  function canChup(){
    const arr = visibleCenterForCombos();
    const top = arr[arr.length-1];
    const hudFlags = {face:false, fourColor:false, threeSuit:false, twoRank:false, threeSpecial:false,
      blocked:false, mustSkip:false, onJoker:false, onSeven:false, onHungarian:false }

    if(!top){ return {allowed:false, reason:'√úres kupac'} }

    // tiltott esetek alapszab√°ly szerint
    if(isHungarian(top)) hudFlags.onHungarian=true
    if(top.joker) hudFlags.onJoker=true
    if(top.type==='FR' && top.r==='7') hudFlags.onSeven=true

    // kombin√°ci√≥k
    // 1) k√©peslap (K/Q/J/A)
    if(isFaceCard(top)) hudFlags.face = true

    // 2) 4 azonos sz√≠n egym√°s ut√°n (piros vagy fekete), a l√°thatatlan 7-eseket kihagyva
    if(arr.length>=4){
      const last4 = arr.slice(-4)
      const colors = last4.map(c=>isHungarian(c)? null : (c.color|| (c.s==='‚ô•'||c.s==='‚ô¶'?'R':'B'))).filter(v=>v!=null)
      if(colors.length===4 && colors.every(c=>c===colors[0])) hudFlags.fourColor = true
    }

    // 3) 3 azonos forma egym√°s ut√°n
    if(arr.length>=3){
      const last3 = arr.slice(-3)
      const suits = last3.map(c=> c.type==='FR'? c.s : c.hs).filter(v=>v!=null)
      if(suits.length===3 && suits.every(s=>s===suits[0])) hudFlags.threeSuit = true
    }

    // 4) 2 azonos sz√°m egym√°s ut√°n (FR: rank)
    if(arr.length>=2){
      const [a,b] = arr.slice(-2)
      if(a.type==='FR' && b.type==='FR' && a.r===b.r) hudFlags.twoRank = true
    }

    // 5) 3-as speci√°lis ‚Äì ha a legfels≈ë k√°rtya 3-as
    if(top.type==='FR' && top.r==='3') hudFlags.threeSpecial = true

    // tilt√°sok
    if(hudFlags.onHungarian || hudFlags.onSeven || hudFlags.onJoker){ hudFlags.blocked=true }
    if(state.skipNextSlap){ hudFlags.mustSkip=true }
    if(state.penaltyPhase){ hudFlags.blocked=true }

    const anyCombo = hudFlags.face || hudFlags.fourColor || hudFlags.threeSuit || hudFlags.twoRank || hudFlags.threeSpecial
    const allowed = anyCombo && !hudFlags.blocked && !hudFlags.mustSkip

    return {allowed, hudFlags, top}
  }

  function handleChup(byPlayer=2, opts={}){
    const check = canChup();
    const top = check.top;

    // ha Joker van fel√ºl √©s valaki r√°csap -> +5 b√ºntet√©s
    if(top?.joker){
      penalty(byPlayer, 5, `üö´ Jokerre nem szabad chuppolni! +5 b√ºntet√©s.`)
      renderAll(true); return
    }

    if(state.skipNextSlap){
      penalty(byPlayer, 2, `‚è≠Ô∏è Joker ut√°ni kihagy√°s! +2 b√ºntet√©s.`)
      renderAll(true); return
    }

    if(state.penaltyPhase){ info(`‚õî B√ºntet≈ë lapokra nem szabad chuppolni.`); return }

    if(!check.allowed){
      penalty(byPlayer, 2, `‚ùå Rossz chup! +2 b√ºntet√©s.`)
      renderAll(true); return
    }

    // 3-as speci√°lis eset
    if(top && top.type==='FR' && top.r==='3'){
      // nem nyeri meg a kupacot, helyette magyar lapokat vesz el valakit≈ël
      const target = (byPlayer===2) ? chooseTargetForThree() : autoChooseTargetForThree(byPlayer)
      if(target!=null){
        const stolen = stealHungarian(target, byPlayer, 2)
        info(`üéØ 3-asra chup ‚Äì ${byPlayer===2?'Te':`J√°t√©kos ${byPlayer+1}` } elvett ${stolen.length} magyar lapot a(z) ${target+1}. j√°t√©kost√≥l.`)
      }else{
        info(`3-asra chup ‚Äì nincs elvehet≈ë magyar lap.`)
      }
      // nincs kupacnyer√©s
      renderAll(true); return
    }

    // norm√°l kupacnyer√©s
    const won = state.center.splice(0, state.center.length)
    pushTop(state.players[byPlayer].won, won)
    state.lastWinner = byPlayer
    info(`‚úã Chup! ${byPlayer===2?'Te':'BOT'} megnyerte a kupacot (${won.length} lap). ≈ê kezdi a k√∂vetkez≈ë k√∂rt.`)
    // a k√∂r ≈ëvele indul
    state.turn = byPlayer

    // ha k√∂zben Joker volt a kupacban legut√≥bb a tetej√©n -> m√°r kezelve; de ha az el≈ëz≈ë felcsapott Joker volt, be kell kapcsolni a kihagy√°st
    const last = won[won.length-1]
    if(last?.joker){
      state.skipNextSlap = false; // kiv√©tel: ha k√©t Joker egym√°s ut√°n, a m√°sodikra m√°r szabad ‚Äì ezt a draw kezeli; itt resetelj√ºk biztosan
    }

    renderAll(true)
  }

  function penalty(playerIdx, count, msg){
    info(msg)
    const p = state.players[playerIdx]
    const give = takeTop(p.won, Math.min(count, p.won.length))
    if(give.length){
      pushTop(state.center, give)
      state.penaltyPhase = true
      // kis id≈ë ut√°n feloldjuk a b√ºntet√©s-f√°zist (k√∂vetkez≈ë felcsap√°sn√°l)
      setTimeout(()=>{ state.penaltyPhase=false; renderAll() }, 600)
    }
  }

  function stealHungarian(fromIdx, toIdx, max){
    const from = state.players[fromIdx]
    const to = state.players[toIdx]
    const hu = []
    // a nyerem√©nypakli tetej√©r≈ël visszafel√© keress√ºk a magyar lapokat
    for(let i=from.won.length-1;i>=0 && hu.length<max;i--){
      if(from.won[i].type==='HU'){ hu.push(from.won.splice(i,1)[0]) }
    }
    pushTop(to.won, hu)
    return hu
  }

  function chooseTargetForThree(){
    // egyszer≈± UI: a legk√∂zelebbi olyan j√°t√©kos, akinek van magyar lapja a nyerem√©nyben; ha t√∂bb, v√°laszt√≥ panelt is lehetne ‚Äì most automatikus, hogy a tanul√°s folyamatos legyen
    for(let i=0;i<state.players.length;i++){
      if(i===2) continue
      if(state.players[i].won.some(c=>c.type==='HU')) return i
    }
    return null
  }
  function autoChooseTargetForThree(by){ return chooseTargetForThree() }

  // Joker logika: ha Joker ker√ºl legfel√ºlre felcsap√°skor, a k√∂vetkez≈ë chup-alkalmat ki kell hagyni.
  // Ezt √∫gy kezelj√ºk, hogy amikor Joker ker√ºl a k√∂z√©pre √âS NEM Joker volt k√∂zvetlen el≈ëtte, bekapcsoljuk a skipNextSlap-et.
  // Ha k√©t Joker egym√°s ut√°n j√∂n, a m√°sodikn√°l nem kapcsoljuk be (√≠gy szabad r√° chuppolni).
  function handleJokerFlag(){
    const arr = state.center
    if(arr.length<1) return
    const last = arr[arr.length-1]
    const prev = arr[arr.length-2]
    if(last?.joker){
      if(prev?.joker){ state.skipNextSlap = false; info('üÉèüÉè K√©t Joker egym√°s ut√°n ‚Äì a m√°sodikra szabad chuppolni.') }
      else { state.skipNextSlap = true; info('üÉè Joker! A k√∂vetkez≈ë chupos alkalmat ki kell hagyni.') }
    }
  }

  // Renderel√©s
  function renderAll(ripple=false){
    // paklik sz√°ml√°l√≥val
    state.players.forEach((p,idx)=>{
      const dEl = document.getElementById('deck-'+idx)
      const wEl = document.getElementById('won-'+idx)
      dEl.innerHTML = `<div class="cardvis" style="place-items:center; opacity:.9"><div>${p.deck.length} lap</div></div>`
      wEl.innerHTML = `<div class="cardvis" style="place-items:center; opacity:.9"><div>${p.won.length} lap</div></div>`
    })

    // center top card
    const top = state.center[state.center.length-1]
    if(top){
      topCardEl.style.display='grid'
      topCardEl.className='cardvis'
      if(top.joker){ topCardEl.classList.add('joker') }
      if(top.type==='HU'){ topCardEl.classList.add('hungarian') }
      topCardEl.innerHTML = cardHTML(top)
      if(ripple){ pileEl.classList.remove('ripple'); void pileEl.offsetWidth; pileEl.classList.add('ripple') }
    } else {
      topCardEl.style.display='none'
    }

    // HUD
    const c = canChup();
    renderHUD(c.hudFlags)
    updateTurnInfo()
    handleJokerFlag()
  }

  function cardHTML(c){
    if(c.joker){ return `<div class="rank">JOKER</div><div class="big">‚òÖ</div><div class="rank" style="justify-self:end">JOKER</div>` }
    if(c.type==='FR'){
      const color = (c.color==='R')?'red':'black'
      return `<div class="rank ${color}">${c.r}</div><div class="big ${color}">${c.s}</div><div class="rank ${color}" style="justify-self:end">${c.s}</div>`
    }
    // magyar
    return `<span class="badge">Magyar</span><div class="rank">${c.hr}</div><div class="big">${c.hs}</div><div class="rank" style="justify-self:end">${c.hs}</div>`
  }

  function renderHUD(f){
    hud.innerHTML = ''
    const items = [
      {k:'face', label:'K√©peslap (K/Q/J/A)'},
      {k:'fourColor', label:'4√ó azonos sz√≠n egym√°s ut√°n'},
      {k:'threeSuit', label:'3√ó azonos forma egym√°s ut√°n'},
      {k:'twoRank', label:'2√ó azonos sz√°m egym√°s ut√°n'},
      {k:'threeSpecial', label:'3-as speci√°lis'},
      {k:'onSeven', label:'7-esre tilos', block:true},
      {k:'onJoker', label:'Jokerre tilos', block:true},
      {k:'onHungarian', label:'Magyar lapra tilos', block:true},
      {k:'mustSkip', label:'Joker miatt kihagy√°s', block:true},
    ]
    items.forEach(it=>{
      const el = document.createElement('div')
      el.className = 'chip' + (f?.[it.k] ? (it.block ? ' block' : ' ok') : '')
      el.textContent = it.label
      hud.appendChild(el)
    })
  }

  function info(msg){
    log.innerHTML = `<div style="margin:4px 0">${msg}</div>` + log.innerHTML
  }

  // Esem√©nyek
  document.getElementById('btnStart').onclick = ()=>{ state.mode='learn'; deal(); }
  document.getElementById('btnPractice').onclick = ()=>{ state.mode='practice'; deal(); info('üèì Szabad gyakorl√°s: a botok nem chuppolnak automatikusan.'); }
  document.getElementById('btnDeal').onclick = ()=> deal()
  document.getElementById('btnFlip').onclick = ()=> drawToCenter()
  document.getElementById('btnChup').onclick = ()=> handleChup(2)
  document.getElementById('toggleJokers').onchange = (e)=>{ state.allowJokers = !!e.target.checked; info(`Jokerek ${state.allowJokers? 'bekapcsolva' : 'kikapcsolva'}.`)}

  // billenty≈±
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){ e.preventDefault(); handleChup(2) }
    if(e.key==='ArrowDown'){ drawToCenter() }
  })

  // els≈ë render
  renderAll()
  </script>
</body>
</html>
